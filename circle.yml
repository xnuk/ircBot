machine:
    pre:
        - git config --global user.email "admin@xnu.kr"
        - git config --global user.name "Xnuk Shuman"

dependencies:
    cache_directories:
        - ~/.stack
    override:
        - mkdir -p ~/.local; ln -s $HOME/bin ~/.local/bin
        - curl -L https://www.stackage.org/stack/linux-x86_64 | tar xz --wildcards --strip-components=1 -C ~/bin '*/stack'
        - sudo apt-get update && sudo apt-get install pkg-config perl
        - stack install --only-dependencies

test:
    override:
        - perl nightly.pl
        - git diff --no-ext-diff --quiet --exit-code || sh git.sh
        - stack test && stack install

deployment:
    upload:
        branch: master
        commands:
            - rm -rf ./*
            - rm -rf ./.stack-work
            - git checkout --orphan binary
            - git reset
            - cp ~/.local/bin/xnukbot .
            - git add xnukbot
            - git commit -m 'release'
            - git push -f origin binary
notify:
    webhooks:
        - url: https://www.xnu.kr/webhook/circleci/ircBot
